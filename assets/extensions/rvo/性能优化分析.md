# RVO2 Vector2D æ€§èƒ½ä¼˜åŒ–åˆ†æ

> **çŠ¶æ€ï¼šâœ… å·²å®Œæˆä¼˜åŒ–**  
> æ—¥æœŸï¼š2025-10-21  
> ä¼˜åŒ–æ¨¡å—ï¼šVector2D.tsã€Simulator.tsã€Agent.ts

---

## ğŸ“Š é—®é¢˜ä¸¥é‡ç¨‹åº¦

æ ¹æ®ä»£ç åˆ†æï¼Œå‘ç°ä»¥ä¸‹é«˜é¢‘å¯¹è±¡åˆ›å»ºç‚¹ï¼š

### ğŸ”´ **ä¸¥é‡ï¼ˆæ¯å¸§å¤šæ¬¡åˆ›å»ºï¼‰**

è¿™äº›ä»£ç åœ¨ `Agent.computeNewVelocity()` ä¸­ï¼Œ**æ¯ä¸ª Agent æ¯å¸§éƒ½ä¼šæ‰§è¡Œå¤šæ¬¡**ï¼š

#### Agent.ts - éšœç¢ç‰© ORCA çº¿è®¡ç®—

```typescript
// ç¬¬ 49-50 è¡Œï¼šæ¯ä¸ªéšœç¢ç‰©é‚»å±…éƒ½ä¼šåˆ›å»º 2 ä¸ªä¸´æ—¶å¯¹è±¡
let relativePosition1 = obstacle1.point.minus(this.position)  // ğŸ”´ åˆ›å»ºå¯¹è±¡
let relativePosition2 = obstacle2.point.minus(this.position)  // ğŸ”´ åˆ›å»ºå¯¹è±¡

// ç¬¬ 59 è¡Œï¼šåµŒå¥—å¾ªç¯ä¸­ï¼Œå¤šæ¬¡è®¡ç®—åˆ›å»ºä¸´æ—¶å¯¹è±¡
relativePosition1.scale(invTimeHorizonObst).minus(orcaLines[j].point)  // ğŸ”´ğŸ”´ 2ä¸ªå¯¹è±¡

// ç¬¬ 76-78 è¡Œï¼šæ¯ä¸ªéšœç¢ç‰©åˆ›å»º 3+ ä¸ªä¸´æ—¶å¯¹è±¡
let obstacleVector = obstacle2.point.minus(obstacle1.point)  // ğŸ”´
let distSqLine = RVOMath.absSq(relativePosition1.scale(-1).minus(obstacleVector.scale(s)))  // ğŸ”´ğŸ”´ğŸ”´ 3ä¸ªå¯¹è±¡

// ç¬¬ 85-86, 94-95, 101 è¡Œï¼šåˆ›å»º Line å¯¹è±¡
line.point = new Vector2D(0, 0)  // ğŸ”´
line.direction = RVOMath.normalize(new Vector2D(-relativePosition1.y, relativePosition1.x))  // ğŸ”´ğŸ”´

// ç¬¬ 128-129, 143-144, 149, 157 è¡Œï¼šè®¡ç®—è…¿éƒ¨æ–¹å‘
leftLegDirection = (new Vector2D(relativePosition1.x * leg1 - ..., ...)).scale(...)  // ğŸ”´ğŸ”´

// ç¬¬ 203, 211, 228, 239, 250, 287, 295, 299, 317, 521 è¡Œ
line.direction = new Vector2D(unitW.y, -unitW.x)  // ğŸ”´ å¤šæ¬¡åˆ›å»ºå‚ç›´å‘é‡
```

**å½±å“ï¼š** 
- å‡è®¾ 100 ä¸ª Agentï¼Œæ¯ä¸ªæœ‰ 10 ä¸ªéšœç¢ç‰©é‚»å±…
- æ¯å¸§åˆ›å»ºå¯¹è±¡ï¼š100 Ã— 10 Ã— 20 = **20,000 ä¸ªå¯¹è±¡/å¸§**
- 60 FPS = **1,200,000 ä¸ªå¯¹è±¡/ç§’** âš ï¸

---

### ğŸŸ¡ **ä¸­ç­‰ï¼ˆè®¾ç½®æ—¶åˆ›å»ºï¼‰**

#### Simulator.ts

```typescript
// ç¬¬ 40 è¡Œï¼šsetAgentPrefVelocity - æ¯æ¬¡è®¾ç½®éƒ½åˆ›å»ºæ–°å¯¹è±¡
this.agents[i].prefVelocity = new Vector2D(vx, vy);  // ğŸŸ¡

// ç¬¬ 44 è¡Œï¼šsetAgentPosition - æ¯æ¬¡è®¾ç½®éƒ½åˆ›å»ºæ–°å¯¹è±¡
this.agents[i].position = new Vector2D(x, y);  // ğŸŸ¡

// ç¬¬ 48 è¡Œï¼šsetAgentGoal - æ¯æ¬¡è®¾ç½®éƒ½åˆ›å»ºæ–°å¯¹è±¡
this.goals[i] = new Vector2D(x, y);  // ğŸŸ¡

// ç¬¬ 145 è¡Œï¼šsetAgentDefaults - åˆå§‹åŒ–æ—¶åˆ›å»º
this.defaultAgent.velocity = new Vector2D(velocityX, velocityY);  // ğŸŸ¡
```

**å½±å“ï¼š** 
- å¦‚æœæ¯å¸§æ›´æ–°ç›®æ ‡/é€Ÿåº¦ï¼Œä¼šåˆ›å»ºå¤§é‡å¯¹è±¡
- å»ºè®®ä½¿ç”¨ `set()` æ–¹æ³•ä¿®æ”¹ç°æœ‰å¯¹è±¡

---

### ğŸŸ¢ **è½»å¾®ï¼ˆåˆå§‹åŒ–æ—¶åˆ›å»ºï¼‰**

```typescript
// ç¬¬ 80 è¡Œï¼šaddAgent - åªåœ¨æ·»åŠ  Agent æ—¶åˆ›å»º
if (!position) position = new Vector2D(0, 0);  // ğŸŸ¢

// ç¬¬ 168 è¡Œï¼šreachedGoal - æ£€æŸ¥ç›®æ ‡æ—¶åˆ›å»ºä¸´æ—¶å¯¹è±¡
if (RVOMath.absSq(this.goals[i].minus(pos)) > ...)  // ğŸŸ¢
```

---

## ğŸ¯ ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šä½¿ç”¨å¯¹è±¡æ± ï¼ˆæ¨èï¼‰

#### æ­¥éª¤ 1ï¼šä¿®æ”¹ Simulator.ts

```typescript
// ä¿®æ”¹å‰
setAgentPrefVelocity(i: number, vx, vy) {
    this.agents[i].prefVelocity = new Vector2D(vx, vy);
}

// ä¿®æ”¹å âœ…
setAgentPrefVelocity(i: number, vx, vy) {
    if (!this.agents[i].prefVelocity) {
        this.agents[i].prefVelocity = new Vector2D();
    }
    this.agents[i].prefVelocity.set(vx, vy);
}

// ä¿®æ”¹å‰
setAgentPosition(i: number, x: number, y: number) {
    this.agents[i].position = new Vector2D(x, y);
}

// ä¿®æ”¹å âœ…
setAgentPosition(i: number, x: number, y: number) {
    if (!this.agents[i].position) {
        this.agents[i].position = new Vector2D();
    }
    this.agents[i].position.set(x, y);
}

// ä¿®æ”¹å‰
setAgentGoal(i: number, x: number, y: number) {
    this.goals[i] = new Vector2D(x, y);
}

// ä¿®æ”¹å âœ…
setAgentGoal(i: number, x: number, y: number) {
    if (!this.goals[i]) {
        this.goals[i] = new Vector2D();
    }
    this.goals[i].set(x, y);
}

// ä¿®æ”¹å‰
setAgentDefaults(..., velocityX: number = 0, velocityY: number = 0) {
    // ...
    this.defaultAgent.velocity = new Vector2D(velocityX, velocityY);
}

// ä¿®æ”¹å âœ…
setAgentDefaults(..., velocityX: number = 0, velocityY: number = 0) {
    // ...
    if (!this.defaultAgent.velocity) {
        this.defaultAgent.velocity = new Vector2D();
    }
    this.defaultAgent.velocity.set(velocityX, velocityY);
}

// ä¿®æ”¹å‰
reachedGoal(): boolean {
    let pos: Vector2D;
    for (var i = 0, len = this.getNumAgents(); i < len; ++i) {
        pos = this.getAgentPosition(i);
        if (RVOMath.absSq(this.goals[i].minus(pos)) > RVOMath.RVO_EPSILON) {
            return false;
        }
    }
    return true;
}

// ä¿®æ”¹å âœ…ï¼ˆä½¿ç”¨ä¸´æ—¶å‘é‡ï¼‰
private _tempVec = new Vector2D();

reachedGoal(): boolean {
    let pos: Vector2D;
    for (var i = 0, len = this.getNumAgents(); i < len; ++i) {
        pos = this.getAgentPosition(i);
        // ä½¿ç”¨ä¸´æ—¶å‘é‡é¿å…åˆ›å»ºæ–°å¯¹è±¡
        this._tempVec.copy(this.goals[i]).subSelf(pos);
        if (RVOMath.absSq(this._tempVec) > RVOMath.RVO_EPSILON) {
            return false;
        }
    }
    return true;
}
```

---

### æ–¹æ¡ˆ 2ï¼šé‡æ„ Agent.tsï¼ˆé«˜æ€§èƒ½å…³é”®ï¼‰

è¿™æ˜¯**æœ€é‡è¦çš„ä¼˜åŒ–**ï¼Œå› ä¸ºè¿™äº›ä»£ç æ¯å¸§æ¯ä¸ª Agent éƒ½ä¼šæ‰§è¡Œã€‚

#### ä¼˜åŒ–æ€è·¯

1. **ä¸º Agent æ·»åŠ ä¸´æ—¶å‘é‡æ± **
2. **ä½¿ç”¨ `set()` å’Œ `copy()` æ›¿ä»£åˆ›å»ºæ–°å¯¹è±¡**
3. **æ·»åŠ ä¸“ç”¨çš„å‘é‡è®¡ç®—æ–¹æ³•**

```typescript
// Agent.ts æ·»åŠ ä¸´æ—¶å‘é‡
export default class Agent {
    // ... åŸæœ‰å±æ€§ ...
    
    // ä¸´æ—¶å‘é‡æ± ï¼Œé¿å…é¢‘ç¹åˆ›å»º
    private _temp1 = new Vector2D();
    private _temp2 = new Vector2D();
    private _temp3 = new Vector2D();
    private _temp4 = new Vector2D();
    
    computeNewVelocity() {
        this.orcaLines.length = 0;
        let orcaLines = this.orcaLines;
        const invTimeHorizonObst = 1.0 / this.timeHorizonObst;
        
        for (var i = 0; i < this.obstaclNeighbors.length; ++i) {
            let obstacle1: Obstacle = this.obstaclNeighbors[i].value;
            let obstacle2 = obstacle1.next;
            
            // ä¿®æ”¹å‰ âŒ
            // let relativePosition1 = obstacle1.point.minus(this.position)
            // let relativePosition2 = obstacle2.point.minus(this.position)
            
            // ä¿®æ”¹å âœ… ä½¿ç”¨ä¸´æ—¶å‘é‡
            this._temp1.copy(obstacle1.point).subSelf(this.position);  // relativePosition1
            this._temp2.copy(obstacle2.point).subSelf(this.position);  // relativePosition2
            let relativePosition1 = this._temp1;
            let relativePosition2 = this._temp2;
            
            // ... åç»­ä½¿ç”¨ relativePosition1/2 ...
            
            // ä¿®æ”¹å‰ âŒ
            // let obstacleVector = obstacle2.point.minus(obstacle1.point)
            
            // ä¿®æ”¹å âœ…
            this._temp3.copy(obstacle2.point).subSelf(obstacle1.point);
            let obstacleVector = this._temp3;
            
            // ä¿®æ”¹å‰ âŒ
            // let distSqLine = RVOMath.absSq(
            //     relativePosition1.scale(-1).minus(obstacleVector.scale(s))
            // );
            
            // ä¿®æ”¹å âœ…
            this._temp4.copy(relativePosition1)
                .scaleSelf(-1)
                .subSelf(this._temp3.copy(obstacleVector).scaleSelf(s));
            let distSqLine = RVOMath.absSq(this._temp4);
            
            // ... æ›´å¤šä¼˜åŒ– ...
        }
    }
}
```

---

### æ–¹æ¡ˆ 3ï¼šæ·»åŠ ä¸“ç”¨å·¥å…·æ–¹æ³•

ä¸ºäº†è®©ä»£ç æ›´æ¸…æ™°ï¼Œå¯ä»¥æ·»åŠ ä¸€äº›ä¸“ç”¨æ–¹æ³•ï¼š

```typescript
// Vector2D.ts æ·»åŠ æ–¹æ³•
export default class Vector2D {
    // ... ç°æœ‰ä»£ç  ...
    
    /**
     * åˆ›å»ºå‚ç›´å‘é‡ï¼ˆä¸åˆ†é…æ–°å¯¹è±¡ï¼‰
     * @param out è¾“å‡ºå‘é‡
     */
    perpendicular(out: Vector2D = null): Vector2D {
        if (!out) out = new Vector2D();
        out.x = this.y;
        out.y = -this.x;
        return out;
    }
    
    /**
     * è®¡ç®—ä¸¤ç‚¹ä¹‹é—´çš„å‘é‡ï¼ˆfrom -> toï¼‰
     */
    static subtract(from: Vector2D, to: Vector2D, out: Vector2D): Vector2D {
        out.x = to.x - from.x;
        out.y = to.y - from.y;
        return out;
    }
    
    /**
     * è·ç¦»å¹³æ–¹
     */
    static distanceSq(a: Vector2D, b: Vector2D): number {
        const dx = b.x - a.x;
        const dy = b.y - a.y;
        return dx * dx + dy * dy;
    }
}

// Agent.ts ä½¿ç”¨ç¤ºä¾‹
// ä¿®æ”¹å‰ âŒ
// line.direction = new Vector2D(unitW.y, -unitW.x)

// ä¿®æ”¹å âœ…
unitW.perpendicular(line.direction);
```

---

## ğŸ“ˆ æ€§èƒ½æå‡é¢„æœŸ

| ä¼˜åŒ–é¡¹ | å¯¹è±¡åˆ›å»ºå‡å°‘ | æ€§èƒ½æå‡ |
|--------|-------------|---------|
| Simulator.ts | ~100/å¸§ | +5% |
| Agent.ts éƒ¨åˆ†ä¼˜åŒ– | ~10,000/å¸§ | +30% |
| Agent.ts å®Œå…¨ä¼˜åŒ– | ~20,000/å¸§ | +50-70% |
| ä½¿ç”¨å¯¹è±¡æ±  | ~25,000/å¸§ | +80-100% |

---

## ğŸš€ æ¨èä¼˜åŒ–ä¼˜å…ˆçº§

### ä¼˜å…ˆçº§ 1ï¼ˆç«‹å³ä¼˜åŒ–ï¼‰â­â­â­
- Simulator.ts çš„ `setAgentPrefVelocity/Position/Goal` æ–¹æ³•
- Agent.ts çš„ `computeNewVelocity` ä¸­çš„ä¸´æ—¶å¯¹è±¡

### ä¼˜å…ˆçº§ 2ï¼ˆé‡è¦ä¼˜åŒ–ï¼‰â­â­
- Agent.ts å…¶ä»–è®¡ç®—å¯†é›†æ–¹æ³•
- RVOMath ä¸­çš„å·¥å…·å‡½æ•°

### ä¼˜å…ˆçº§ 3ï¼ˆé”¦ä¸Šæ·»èŠ±ï¼‰â­
- åˆå§‹åŒ–ä»£ç ä¼˜åŒ–
- ä½é¢‘è°ƒç”¨çš„æ–¹æ³•

---

## ğŸ’¡ ä½¿ç”¨å»ºè®®

1. **å¼€å‘é˜¶æ®µ**ï¼šå…ˆä¿æŒç°æœ‰ä»£ç ï¼Œç¡®ä¿é€»è¾‘æ­£ç¡®
2. **æ€§èƒ½ç“¶é¢ˆæ—¶**ï¼šæŒ‰ä¼˜å…ˆçº§é€æ­¥ä¼˜åŒ–
3. **æµ‹è¯•éªŒè¯**ï¼šæ¯æ¬¡ä¼˜åŒ–åè¿›è¡Œæ€§èƒ½æµ‹è¯•
4. **ä»£ç å®¡æŸ¥**ï¼šç¡®ä¿ä¼˜åŒ–æ²¡æœ‰å¼•å…¥ bug

---

## ğŸ”§ å®Œæ•´ä¼˜åŒ–ç¤ºä¾‹

### åˆå§‹åŒ–æ—¶é¢„çƒ­å¯¹è±¡æ± 

```typescript
// åœ¨æ¸¸æˆå¼€å§‹æ—¶
Vector2D.warmupPool(1000);  // é¢„åˆ›å»º 1000 ä¸ªå¯¹è±¡

// åœ¨åœºæ™¯åˆ‡æ¢æ—¶
Vector2D.clearPool();  // æ¸…ç†æ± 
```

### åœ¨é«˜é¢‘è¿ç®—ä¸­ä½¿ç”¨

```typescript
// Agent.ts
computeNewVelocity() {
    // ä»æ± ä¸­è·å–
    const temp1 = Vector2D.get();
    const temp2 = Vector2D.get();
    
    // ä½¿ç”¨
    temp1.copy(obstacle1.point).subSelf(this.position);
    temp2.copy(obstacle2.point).subSelf(this.position);
    
    // è®¡ç®—å®Œæˆåå›æ”¶
    Vector2D.put(temp1);
    Vector2D.put(temp2);
}
```

### ç›‘æ§å¯¹è±¡æ± çŠ¶æ€

```typescript
// å®šæœŸæ£€æŸ¥æ± çŠ¶æ€
setInterval(() => {
    const stats = Vector2D.getPoolStats();
    console.log('å¯¹è±¡æ± çŠ¶æ€:', stats.usage);
}, 1000);
```

