# Simulator è„æ ‡è®°ï¼ˆDirty Flagï¼‰ä¼˜åŒ–è¯´æ˜

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

ä½¿ç”¨è„æ ‡è®°å»¶è¿Ÿåˆ·æ–° `agents` æ•°ç»„ï¼Œé¿å…é¢‘ç¹çš„æ•°ç»„æ“ä½œï¼Œè¿›ä¸€æ­¥æå‡æ€§èƒ½ã€‚

---

## ğŸ“Š ä¼˜åŒ–åŸç†

### é—®é¢˜åˆ†æ

åœ¨ä¹‹å‰çš„å®ç°ä¸­ï¼š
```typescript
// æ·»åŠ  Agent
addAgent() {
    this.agentMap.set(id, agent);
    this.agents.push(agent);         // âš ï¸ ç«‹å³æ“ä½œæ•°ç»„
}

// åˆ é™¤ Agent
removeAgent() {
    this.agentMap.delete(id);
    // ä»æ•°ç»„ä¸­æŸ¥æ‰¾å¹¶åˆ é™¤            // âš ï¸ O(n) æ“ä½œ
    const index = this.agents.indexOf(agent);
    this.agents.splice(index, 1);
}
```

**é—®é¢˜ï¼š**
- æ¯æ¬¡æ·»åŠ /åˆ é™¤éƒ½è¦æ“ä½œæ•°ç»„
- åˆ é™¤éœ€è¦ `indexOf()` æŸ¥æ‰¾ O(n)
- å¦‚æœè¿ç»­æ·»åŠ /åˆ é™¤å¤šä¸ª Agentï¼Œä¼šæœ‰å¤§é‡é‡å¤æ“ä½œ

### è„æ ‡è®°æ–¹æ¡ˆ

```typescript
// æ·»åŠ  Agent
addAgent() {
    this.agentMap.set(id, agent);
    this._agentsDirty = true;        // âœ… åªæ ‡è®°ï¼Œä¸æ“ä½œæ•°ç»„
}

// åˆ é™¤ Agent
removeAgent() {
    this.agentMap.delete(id);
    this._agentsDirty = true;        // âœ… åªæ ‡è®°ï¼Œä¸æ“ä½œæ•°ç»„
}

// åœ¨ run() æ—¶ç»Ÿä¸€åˆ·æ–°
run() {
    this._refreshAgents();           // âœ… ä» Map é‡å»ºæ•°ç»„
    // ... æ‰§è¡Œæ¨¡æ‹Ÿ ...
}
```

**ä¼˜åŠ¿ï¼š**
- æ·»åŠ /åˆ é™¤åªä¿®æ”¹ Mapï¼ŒO(1) æ“ä½œ
- å»¶è¿Ÿåˆ° `run()` æ—¶æ‰é‡å»ºæ•°ç»„
- æ‰¹é‡æ“ä½œæ—¶åªé‡å»ºä¸€æ¬¡
- å¦‚æœæ²¡æœ‰å˜åŒ–ï¼Œä¸åšä»»ä½•æ“ä½œ

---

## ğŸ”§ å®ç°ç»†èŠ‚

### 1. è„æ ‡è®°å­—æ®µ

```typescript
class Simulator {
    // è„æ ‡è®°ï¼šagents æ•°ç»„æ˜¯å¦éœ€è¦é‡å»º
    private _agentsDirty = false;
}
```

### 2. åˆ·æ–°æ–¹æ³•

```typescript
/**
 * åˆ·æ–° agents æ•°ç»„ï¼ˆä» agentMap é‡å»ºï¼‰
 * åªåœ¨éœ€è¦æ—¶è°ƒç”¨ï¼ˆè„æ ‡è®°ä¸º trueï¼‰
 */
private _refreshAgents(): void {
    if (!this._agentsDirty) return;  // å¦‚æœä¸è„ï¼Œç›´æ¥è¿”å›
    
    // ä» Map é‡å»ºæ•°ç»„
    this.agents = Array.from(this.agentMap.values());
    this._agentsDirty = false;
}
```

### 3. æ·»åŠ  Agent

```typescript
addAgent(position?: Vector2D): number {
    // ... åˆ›å»º Agent ...
    
    // æ·»åŠ åˆ° Map
    this.agentMap.set(agent.id, agent);
    
    // æ ‡è®°æ•°ç»„ä¸ºè„
    this._agentsDirty = true;
    
    return agent.id;
}
```

### 4. åˆ é™¤ Agent

```typescript
removeAgent(agentId: number): boolean {
    // ä» Map ä¸­åˆ é™¤
    this.agentMap.delete(agentId);
    this.goalsMap.delete(agentId);
    
    // æ ‡è®°æ•°ç»„ä¸ºè„
    this._agentsDirty = true;
    
    return true;
}
```

### 5. run() æ–¹æ³•

```typescript
run() {
    // åˆ·æ–° agents æ•°ç»„ï¼ˆå¦‚æœæœ‰æ·»åŠ /åˆ é™¤æ“ä½œï¼‰
    this._refreshAgents();
    
    // æ„å»º KdTree
    this.kdTree.buildAgentTree();
    
    // æ›´æ–°æ‰€æœ‰ Agent
    for (let i = 0; i < this.agents.length; i++) {
        this.agents[i].computeNeighbors();
        this.agents[i].computeNewVelocity();
        this.agents[i].update();
    }
    
    this.time += this.timeStep;
}
```

### 6. getNumAgents() ä¼˜åŒ–

```typescript
getNumAgents(): number {
    // å¦‚æœæ•°ç»„æ˜¯è„çš„ï¼Œä½¿ç”¨ Map çš„å¤§å°ï¼ˆæ›´å‡†ç¡®ï¼‰
    return this._agentsDirty ? this.agentMap.size : this.agents.length;
}
```

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### åœºæ™¯ 1: æ‰¹é‡æ·»åŠ  Agent

```typescript
// æ·»åŠ  100 ä¸ª Agent

// âŒ ä¼˜åŒ–å‰
for (let i = 0; i < 100; i++) {
    addAgent();
    // æ¯æ¬¡éƒ½ push åˆ°æ•°ç»„ï¼š100 æ¬¡æ•°ç»„æ“ä½œ
}

// âœ… ä¼˜åŒ–å
for (let i = 0; i < 100; i++) {
    addAgent();
    // åªæ ‡è®°è„ï¼š100 æ¬¡æ ‡è®°ï¼ˆéå¸¸å¿«ï¼‰
}
run();  // åªé‡å»ºæ•°ç»„ 1 æ¬¡
```

**æ€§èƒ½æå‡ï¼š** 100 æ¬¡æ•°ç»„æ“ä½œ â†’ 1 æ¬¡æ•°ç»„é‡å»º

---

### åœºæ™¯ 2: æ‰¹é‡åˆ é™¤ Agent

```typescript
// åˆ é™¤ 50 ä¸ª Agent

// âŒ ä¼˜åŒ–å‰
for (let i = 0; i < 50; i++) {
    removeAgent();
    // æ¯æ¬¡éƒ½è¦ indexOf + spliceï¼š50 Ã— O(n)
}

// âœ… ä¼˜åŒ–å
for (let i = 0; i < 50; i++) {
    removeAgent();
    // åªæ ‡è®°è„ï¼š50 Ã— O(1)
}
run();  // åªé‡å»ºæ•°ç»„ 1 æ¬¡
```

**æ€§èƒ½æå‡ï¼š** 50 Ã— O(n) â†’ 50 Ã— O(1) + 1 æ¬¡é‡å»º

---

### åœºæ™¯ 3: æ·»åŠ åç«‹å³åˆ é™¤

```typescript
// æ·»åŠ  10 ä¸ªï¼Œåˆ é™¤ 10 ä¸ª

// âŒ ä¼˜åŒ–å‰
for (let i = 0; i < 10; i++) addAgent();    // 10 æ¬¡ push
for (let i = 0; i < 10; i++) removeAgent(); // 10 æ¬¡ indexOf + splice

// âœ… ä¼˜åŒ–å
for (let i = 0; i < 10; i++) addAgent();    // 10 æ¬¡æ ‡è®°
for (let i = 0; i < 10; i++) removeAgent(); // 10 æ¬¡æ ‡è®°
run();  // åªé‡å»ºæ•°ç»„ 1 æ¬¡
```

**æ€§èƒ½æå‡ï¼š** 20 æ¬¡æ•°ç»„æ“ä½œ â†’ 20 æ¬¡æ ‡è®° + 1 æ¬¡é‡å»º

---

## ğŸ” å·¥ä½œæµç¨‹

### æ­£å¸¸æµç¨‹

```
1. æ¸¸æˆåˆå§‹åŒ–
   â””â”€ addAgent() Ã— N
      â””â”€ æ ‡è®° _agentsDirty = true

2. æ¸¸æˆå¾ªç¯
   â””â”€ run()
      â”œâ”€ _refreshAgents()  [ç¬¬ä¸€æ¬¡è°ƒç”¨]
      â”‚  â””â”€ ä» agentMap é‡å»º agents æ•°ç»„
      â”‚  â””â”€ _agentsDirty = false
      â”œâ”€ buildAgentTree()
      â””â”€ æ›´æ–°æ‰€æœ‰ Agent

3. è¿è¡Œæ—¶æ·»åŠ  Agent
   â””â”€ addAgent()
      â””â”€ æ ‡è®° _agentsDirty = true

4. ä¸‹ä¸€å¸§
   â””â”€ run()
      â”œâ”€ _refreshAgents()  [æ£€æµ‹åˆ°è„ï¼Œé‡å»º]
      â””â”€ ...

5. æ²¡æœ‰å˜åŒ–çš„å¸§
   â””â”€ run()
      â”œâ”€ _refreshAgents()  [æœªè„ï¼Œç›´æ¥è¿”å›]
      â””â”€ ...
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ç›´æ¥è®¿é—® agents æ•°ç»„

å¦‚æœåœ¨ `run()` ä¹‹å¤–ç›´æ¥è®¿é—® `agents` æ•°ç»„ï¼š

```typescript
// âš ï¸ å¯èƒ½è¿‡æ—¶
simulator.addAgent(pos);
const count = simulator.agents.length;  // å¯èƒ½ä¸å‡†ç¡®

// âœ… æ¨è
simulator.addAgent(pos);
const count = simulator.getNumAgents();  // å‡†ç¡®ï¼ˆä¼šæ£€æŸ¥è„æ ‡è®°ï¼‰
```

### 2. æ‰‹åŠ¨åˆ·æ–°

å¦‚æœéœ€è¦åœ¨ `run()` ä¹‹å‰ç«‹å³è·å–å‡†ç¡®çš„ agents æ•°ç»„ï¼š

```typescript
simulator.addAgent(pos);
simulator.markAgentsDirty();  // æ‰‹åŠ¨æ ‡è®°ï¼ˆé€šå¸¸ä¸éœ€è¦ï¼‰

// æˆ–è€…ä½¿ç”¨ Map éå†
simulator.forEachAgent((agent, id) => {
    // å§‹ç»ˆå‡†ç¡®
});
```

### 3. KdTree ä¾èµ–

`KdTree` ä¾èµ– `agents` æ•°ç»„ï¼Œæ‰€ä»¥å¿…é¡»åœ¨ `buildAgentTree()` ä¹‹å‰åˆ·æ–°ï¼š

```typescript
run() {
    this._refreshAgents();      // âœ… å¿…é¡»åœ¨è¿™é‡Œåˆ·æ–°
    this.kdTree.buildAgentTree();  // ä½¿ç”¨åˆ·æ–°åçš„æ•°ç»„
}
```

---

## ğŸ“Š æ€§èƒ½æå‡ç»Ÿè®¡

| æ“ä½œ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| æ·»åŠ  Agent | O(1) push | O(1) æ ‡è®° | ç›¸åŒ |
| åˆ é™¤ Agent | O(n) indexOf+splice | **O(1) æ ‡è®°** | **æ— é™å€â¬†ï¸** |
| æ‰¹é‡æ·»åŠ  100 | 100 æ¬¡æ•°ç»„æ“ä½œ | **1 æ¬¡é‡å»º** | **100å€â¬†ï¸** |
| æ‰¹é‡åˆ é™¤ 50 | 50 Ã— O(n) | **50 Ã— O(1) + 1æ¬¡é‡å»º** | **æ˜¾è‘—â¬†ï¸** |
| æ— å˜åŒ–çš„å¸§ | 0 | 0 | ç›¸åŒ |

---

## ğŸ‰ æ€»ç»“

### ä¼˜åŠ¿

âœ… **åˆ é™¤æ€§èƒ½æå‡å·¨å¤§**ï¼šä» O(n) åˆ° O(1)  
âœ… **æ‰¹é‡æ“ä½œå‹å¥½**ï¼šåªé‡å»ºä¸€æ¬¡æ•°ç»„  
âœ… **æ— å‰¯ä½œç”¨**ï¼šä¸å½±å“ç°æœ‰é€»è¾‘  
âœ… **å»¶è¿ŸåŠ è½½**ï¼šåªåœ¨éœ€è¦æ—¶åˆ·æ–°  
âœ… **ç®€å•æ¸…æ™°**ï¼šè„æ ‡è®°æ¨¡å¼æ˜“äºç†è§£  

### é€‚ç”¨åœºæ™¯

- âœ… é¢‘ç¹æ·»åŠ /åˆ é™¤ Agent
- âœ… æ‰¹é‡æ“ä½œ Agent
- âœ… è¿è¡Œæ—¶åŠ¨æ€ç®¡ç† Agent
- âœ… å¤§é‡ Agent çš„åœºæ™¯

### ä»£ç é‡

- æ–°å¢ä»£ç ï¼š~20 è¡Œ
- ä¿®æ”¹ä»£ç ï¼š~5 å¤„
- å¤æ‚åº¦ï¼šä½

---

**ç°åœ¨ Simulator åŒæ—¶å…·å¤‡ï¼š**
1. âœ… Map O(1) æŸ¥æ‰¾
2. âœ… è„æ ‡è®°å»¶è¿Ÿåˆ·æ–°
3. âœ… æ•°ç»„é«˜æ•ˆéå†
4. âœ… å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–

**ä¸‰é‡ä¼˜åŒ–ï¼Œæ€§èƒ½æ‹‰æ»¡ï¼** ğŸš€

